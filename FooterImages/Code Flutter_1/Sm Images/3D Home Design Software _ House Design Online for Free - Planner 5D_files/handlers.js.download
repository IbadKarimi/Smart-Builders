P5D.Handlers.imageSaveToStorageHandler = (target, url) => {
	const editor = target.quill || {};
	const input = document.createElement('input');
	input.setAttribute('type', 'file');
	input.setAttribute('name', 'image');
	input.setAttribute('accept', 'image/*');
	input.click();
	
	input.onchange = () => {
		const file = input.files[0];
		const formData = new FormData();
		const range = editor.getSelection(true);
		
		formData.append('image', file);
		editor.insertEmbed(range.index, 'image',  '/s/6/images/loading.gif');
		editor.setSelection(range.index + 1);
		
		$.ajax({
			url: url,
			type: 'post',
			data: formData,
			contentType: false,
			processData: false,
			headers: {'Accept-Language': P5D.getContext().getLanguage()},
			success: function(response){
				const data = JSON.parse(response);
				if(data.upload) {
					editor.deleteText(range.index, 1);
					editor.insertEmbed(range ? range.index : 0, 'image', data.upload.links.original);
				} else {
					P5D.Dialogs.error('Error. Please try later.');
				}
			},
			error: function () {
				P5D.Dialogs.error('Error. Please try later.');
			}
		});
	}
};
